<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI êµì‚¬ ë³´ì¡° ë„êµ¬ (í‰ì–´ & í–‰ë°œ & ì°½ì²´ & ê³¼ëª©ë³„ í‰ê°€)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS (Excel Parsing) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background-color: #f3f4f6; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
        /* Checkbox Visuals for 3-state */
        .trait-box {
            transition: all 0.2s;
        }
        .trait-box.state-1 {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
            color: #1e40af; /* blue-800 */
        }
        .trait-box.state-2 {
            background-color: #ffedd5; /* orange-100 */
            border-color: #f97316; /* orange-500 */
            color: #9a3412; /* orange-800 */
        }
        /* Toast Notification Style */
        .toast-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(31, 41, 55, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 9999;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: pre-line;
            text-align: center;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast-notification.hide {
            opacity: 0;
            transform: translateX(-50%) translateY(10px);
        }
        /* Excel Table Style */
        .excel-table th, .excel-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            font-size: 0.875rem;
        }
        .excel-table th {
            background-color: #f9fafb;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ë°ì´í„° ì •ì˜ ---
        const BEHAVIOR_CATEGORIES = {
            "í•™ìŠµ": ["í•™ìŠµ(ìš°ìˆ˜)", "í•™ìŠµ(ë°œì „ê°€ëŠ¥)", "í•™ìŠµ(ì œì•ˆ)"],
            "ì„±ê²©": ["ëˆê¸°", "ì˜ˆì˜", "ë°°ë ¤", "ë…ì„œ", "êµìš°ê´€ê³„", "ê·œì¹™ì¤€ìˆ˜", "ì†Œì‹ ", "ë´‰ì‚¬", "ê°ˆë“±ê´€ë¦¬", "ì±…ì„ê°", "ë°œí‘œ", "í˜‘ë ¥", "ìœ ë¨¸"],
            "ì˜ˆì²´ëŠ¥": ["ìŒì•…", "ë¯¸ìˆ ", "ì²´ìœ¡"]
        };

        const App = () => {
            // --- Common State ---
            const [mode, setMode] = useState('comment'); 
            const [apiKey, setApiKey] = useState('');
            
            // ëª¨ë¸ ê´€ë ¨ State
            const [model, setModel] = useState('gemini-1.5-flash'); 
            const [modelList, setModelList] = useState([
                { name: 'models/gemini-2.5-flash', displayName: 'gemini-2.5-flash (ìµœì‹ /ë¹ ë¦„)' },
                { name: 'models/gemini-2.5-pro', displayName: 'gemini-2.5-pro (ìµœì‹ /ê³ ì„±ëŠ¥/ëŠë¦¼)' },
                { name: 'models/gemini-1.5-flash', displayName: 'gemini-1.5-flash (ì•ˆì •/ê¸°ë³¸)' },
                { name: 'models/gemini-1.5-pro', displayName: 'gemini-1.5-pro (ê³ ì„±ëŠ¥/ëŠë¦¼)' },
                { name: 'models/gemini-1.5-flash-8b', displayName: 'gemini-1.5-flash-8b (ì´ˆê²½ëŸ‰)' }
            ]);
            const [isFetchingModels, setIsFetchingModels] = useState(false);

            const [loading, setLoading] = useState(false);
            const [progressMsg, setProgressMsg] = useState(''); 
            const [error, setError] = useState('');

            // Toast State
            const [toast, setToast] = useState({ show: false, msg: '' });

            // Copied Items State
            const [copiedSet, setCopiedSet] = useState(new Set());

            // --- Comment Gen State (í‰ì–´) ---
            const [standards, setStandards] = useState(['']);
            const [counts, setCounts] = useState({ veryGood: 3, good: 3, average: 3, needsEffort: 3 });
            const [commentResults, setCommentResults] = useState(null);
            const [activeTab, setActiveTab] = useState(0);

            // --- Behavior Gen State (í–‰ë°œ) ---
            const [studentCount, setStudentCount] = useState(1);
            const [students, setStudents] = useState([{ id: 1, name: '', checks: new Map() }]);
            const [targetBytes, setTargetBytes] = useState(700); 
            const [behaviorResults, setBehaviorResults] = useState(null);

            // --- Creative Gen State (ì°½ì²´) ---
            const [creativeInputs, setCreativeInputs] = useState([{ text: '', count: 3 }]);
            const [creativeResults, setCreativeResults] = useState(null);

            // --- Excel Gen State (ê³¼ëª©ë³„ í‰ê°€) ---
            const [excelData, setExcelData] = useState(null); // Parsed Excel Data
            const [excelResults, setExcelResults] = useState(null); // Generated Comments (Student-based)
            const [excelSubjectTab, setExcelSubjectTab] = useState(''); // Current Subject Tab

            // --- Helpers ---
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const showToast = (message) => {
                setToast({ show: true, msg: message });
                setTimeout(() => {
                    setToast(prev => ({ ...prev, show: false }));
                }, 2000);
            };

            const handleCopy = (text, id) => {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                setCopiedSet(prev => {
                    const newSet = new Set(prev);
                    newSet.add(id);
                    return newSet;
                });
            };

            const calculateBytes = (str) => {
                if (!str) return 0;
                let bytes = 0;
                for (let i = 0; i < str.length; i++) {
                    const code = str.charCodeAt(i);
                    if (code > 127) bytes += 3;
                    else bytes += 1;
                }
                return bytes;
            };

            const getModelDelay = (modelName) => {
                if (modelName.toLowerCase().includes('pro')) {
                    return 35000; 
                }
                return 4000; 
            };

            // Excel Data Pivot: Convert [Students with Subjects] -> [Subjects with Students]
            const pivotedExcelData = useMemo(() => {
                if (!excelResults) return null;
                
                const subjectsMap = {};
                
                excelResults.forEach(student => {
                    if (student.results) {
                        Object.keys(student.results).forEach(subject => {
                            if (!subjectsMap[subject]) {
                                subjectsMap[subject] = [];
                            }
                            subjectsMap[subject].push({
                                name: student.name,
                                comment: student.results[subject]
                            });
                        });
                    }
                });
                
                // If no subject is selected yet, select the first one
                const subjectKeys = Object.keys(subjectsMap);
                if (subjectKeys.length > 0 && !excelSubjectTab) {
                    setExcelSubjectTab(subjectKeys[0]);
                }
                
                return subjectsMap;
            }, [excelResults]);


            // --- Logic: Comment Generator ---
            const addStandard = () => setStandards([...standards, '']);
            const removeStandard = (idx) => {
                const newStds = standards.filter((_, i) => i !== idx);
                setStandards(newStds.length ? newStds : ['']);
            };
            const handleStandardChange = (idx, val) => {
                const newStds = [...standards];
                newStds[idx] = val;
                setStandards(newStds);
            };
            const handleCountChange = (level, val) => {
                let num = parseInt(val) || 0;
                setCounts({ ...counts, [level]: Math.min(40, Math.max(0, num)) });
            };

            // --- Logic: Behavior Generator ---
            const handleStudentCountChange = (e) => {
                const count = Math.max(1, Math.min(50, parseInt(e.target.value) || 1));
                setStudentCount(count);
                setStudents(prev => {
                    const newArr = [...prev];
                    if (count > prev.length) {
                        for (let i = prev.length; i < count; i++) newArr.push({ id: i + 1, name: '', checks: new Map() });
                    } else {
                        return newArr.slice(0, count);
                    }
                    return newArr;
                });
            };

            const toggleCheck = (studentIndex, trait) => {
                setStudents(prev => {
                    const newArr = [...prev];
                    const student = { ...newArr[studentIndex] };
                    const newChecks = new Map(student.checks);
                    const currentVal = newChecks.get(trait) || 0;
                    const nextVal = (currentVal + 1) % 3;
                    if (nextVal === 0) newChecks.delete(trait);
                    else newChecks.set(trait, nextVal);
                    student.checks = newChecks;
                    newArr[studentIndex] = student;
                    return newArr;
                });
            };

            const updateStudentName = (idx, val) => {
                setStudents(prev => {
                    const newArr = [...prev];
                    newArr[idx] = { ...newArr[idx], name: val };
                    return newArr;
                });
            };

            // --- Logic: Creative Generator ---
            const addCreativeInput = () => setCreativeInputs([...creativeInputs, { text: '', count: 3 }]);
            const removeCreativeInput = (idx) => {
                const newInputs = creativeInputs.filter((_, i) => i !== idx);
                setCreativeInputs(newInputs.length ? newInputs : [{ text: '', count: 3 }]);
            };
            const handleCreativeChange = (idx, field, val) => {
                const newInputs = [...creativeInputs];
                if (field === 'count') {
                    newInputs[idx][field] = Math.min(20, Math.max(1, parseInt(val) || 1));
                } else {
                    newInputs[idx][field] = val;
                }
                setCreativeInputs(newInputs);
            };

            // --- Logic: Excel Generator ---
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    if (data.length < 2) {
                        setError("ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                        return;
                    }

                    const headers = data[0];
                    const rows = data.slice(1).filter(r => r && r.length > 0);

                    const parsedStudents = rows.map(row => {
                        const studentName = row[0];
                        const subjectData = {};

                        for (let i = 1; i < row.length; i++) {
                            const header = headers[i];
                            if (!header || !header.includes('-')) continue;
                            
                            const parts = header.split('-');
                            const subject = parts[0].trim();
                            const standard = parts.slice(1).join('-').trim();
                            const grade = row[i];

                            if (!subjectData[subject]) {
                                subjectData[subject] = [];
                            }
                            subjectData[subject].push({ standard, grade });
                        }
                        return { name: studentName, subjects: subjectData };
                    });

                    setExcelData(parsedStudents);
                    setExcelResults(null);
                    setExcelSubjectTab('');
                    setError('');
                    showToast(`âœ… ${parsedStudents.length}ëª…ì˜ í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                };
                reader.readAsBinaryString(file);
            };

            const downloadHwp = () => {
                if (!pivotedExcelData) return;

                let htmlContent = `
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                            th, td { border: 1px solid black; padding: 5px; text-align: center; font-family: "Malgun Gothic", serif; }
                            th { background-color: #f0f0f0; }
                            h2 { font-family: "Malgun Gothic", serif; margin-top: 20px; }
                            .left-align { text-align: left; }
                        </style>
                    </head>
                    <body>
                        <h1>ê³¼ëª©ë³„ í‰ì–´ ìƒì„± ê²°ê³¼</h1>
                `;

                // ê³¼ëª©ë³„ë¡œ í…Œì´ë¸” ìƒì„±
                Object.keys(pivotedExcelData).forEach(subject => {
                    const studentsList = pivotedExcelData[subject];
                    htmlContent += `
                        <h2>[${subject}]</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th width="120">ì´ë¦„</th>
                                    <th>í‰ì–´ (ì„¸ë¶€ëŠ¥ë ¥ ë° íŠ¹ê¸°ì‚¬í•­)</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    studentsList.forEach(student => {
                        htmlContent += `
                            <tr>
                                <td>${student.name}</td>
                                <td class="left-align">${student.comment}</td>
                            </tr>
                        `;
                    });

                    htmlContent += `
                            </tbody>
                        </table>
                        <br>
                    `;
                });

                htmlContent += `
                    </body>
                    </html>
                `;

                const blob = new Blob([htmlContent], { type: 'application/msword;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ê³¼ëª©ë³„_í‰ì–´_ê²°ê³¼_${new Date().toLocaleDateString()}.hwp`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- API Model Fetching ---
            const fetchAvailableModels = async () => {
                if (!apiKey) {
                    setError("API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                setIsFetchingModels(true);
                setError("");
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                    if (!response.ok) throw new Error("ëª¨ë¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    const data = await response.json();
                    if (data.models) {
                        const validModels = data.models.filter(m => 
                            m.supportedGenerationMethods && 
                            m.supportedGenerationMethods.includes("generateContent")
                        ).map(m => ({
                            name: m.name,
                            displayName: m.displayName || m.name
                        }));
                        validModels.sort((a, b) => {
                            const getVersion = (name) => {
                                const match = name.match(/(\d+\.\d+)/);
                                return match ? parseFloat(match[0]) : 0;
                            };
                            const verA = getVersion(a.name);
                            const verB = getVersion(b.name);
                            if (verA !== verB) return verB - verA;
                            return b.name.localeCompare(a.name); 
                        });
                        setModelList(validModels);
                        if (validModels.length > 0) {
                            setModel(validModels[0].name.replace('models/', '')); 
                            showToast(`âœ… ëª¨ë¸ ëª©ë¡ ê°±ì‹  ì™„ë£Œ (ìµœì‹ : ${validModels[0].displayName})`);
                        }
                    }
                } catch (err) {
                    setError(`ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ${err.message}`);
                } finally {
                    setIsFetchingModels(false);
                }
            };

            // --- API Call Functions with Auto-Retry ---
            const callGemini = async (prompt, retryCount = 0) => {
                if (!apiKey) throw new Error('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                const cleanModelName = model.startsWith('models/') ? model.split('/')[1] : model;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${cleanModelName}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            safetySettings: [
                                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                            ],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 8192,
                                responseMimeType: "application/json"
                            }
                        })
                    });

                    if (response.status === 429) {
                        if (retryCount < 3) {
                            const baseWait = model.toLowerCase().includes('pro') ? 35000 : 10000;
                            const waitTime = baseWait + (retryCount * 5000); 
                            setProgressMsg(`âš ï¸ ì‚¬ìš©ëŸ‰ ì œí•œ ë„ë‹¬! ${waitTime/1000}ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤... (${retryCount+1}/3)`);
                            await delay(waitTime);
                            return callGemini(prompt, retryCount + 1);
                        } else {
                            throw new Error("âŒ ì‚¬ìš©ëŸ‰ ì œí•œ(Rate Limit) ì´ˆê³¼. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        }
                    }

                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({}));
                        throw new Error(errData.error?.message || `ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
                    }

                    const data = await response.json();
                    if (!data.candidates || data.candidates.length === 0) throw new Error('AI ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
                    
                    const rawText = data.candidates[0].content?.parts?.[0]?.text;
                    if (!rawText) throw new Error('AI ì‘ë‹µ ë¹„ì–´ìˆìŒ');

                    const cleanedText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleanedText);

                } catch (e) {
                    if (e.message.includes("ì‚¬ìš©ëŸ‰ ì œí•œ")) throw e;
                    console.error("Error:", e);
                    throw new Error(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
                }
            };

            // ... (í‰ì–´, í–‰ë°œ, ì°½ì²´ ìƒì„± í•¨ìˆ˜ - ê¸°ì¡´ ìœ ì§€) ...
            const generateComments = async () => { /* ... */ 
                const validStandards = standards.filter(s => s.trim() !== '');
                if (validStandards.length === 0) { setError('ì„±ì·¨ ê¸°ì¤€ ì…ë ¥ í•„ìš”'); return; }
                setLoading(true); setError(''); setCommentResults([]); setCopiedSet(new Set());
                const BATCH_SIZE = 3; const totalBatches = Math.ceil(validStandards.length / BATCH_SIZE);
                let accumulatedResults = [];
                const WAIT_TIME = getModelDelay(model);
                try {
                    for (let i = 0; i < totalBatches; i++) {
                        const start = i * BATCH_SIZE; const end = start + BATCH_SIZE; const batch = validStandards.slice(start, end);
                        setProgressMsg(`í‰ì–´ ìƒì„± ì¤‘... (${i+1}/${totalBatches})`);
                        if (i > 0) await delay(WAIT_TIME);
                        const prompt = `ë‹¹ì‹ ì€ êµì‚¬ì…ë‹ˆë‹¤. ë‹¤ìŒ ì„±ì·¨ ê¸°ì¤€ì— ëŒ€í•´ 4ë‹¨ê³„(ë§¤ìš° ì˜í•¨, ì˜í•¨, ë³´í†µ, ë…¸ë ¥ìš”í•¨) í‰ì–´ë¥¼ ìƒì„±í•˜ì„¸ìš”.
                        [ì…ë ¥]: ${JSON.stringify(batch)}
                        [ê·œì¹™]: 
                        1. ê° ì„±ì·¨ê¸°ì¤€ë³„ë¡œ ë‹¨ê³„ë§ˆë‹¤: ë§¤ìš° ì˜í•¨(${counts.veryGood}ê°œ), ì˜í•¨(${counts.good}ê°œ), ë³´í†µ(${counts.average}ê°œ), ë…¸ë ¥ìš”í•¨(${counts.needsEffort}ê°œ).
                        2. ì–´ë¯¸: "-í•¨.", "-ì„." ë“± ëª…ì‚¬í˜•.
                        3. íŠ¹ìˆ˜ë¬¸ì ê¸ˆì§€. ê°•í•œ ë§ì¶¤ë²• ì ìš©.
                        [ì¶œë ¥(JSON)]: [{ "standard": "...", "levels": { "veryGood": ["..."], ... } }, ...]`;
                        const result = await callGemini(prompt);
                        if (Array.isArray(result)) { accumulatedResults = [...accumulatedResults, ...result]; setCommentResults([...accumulatedResults]); }
                    }
                    if (accumulatedResults.length > 0) setActiveTab(0);
                } catch (err) { setError(err.message); } finally { setLoading(false); setProgressMsg(''); }
            };

            const generateBehavior = async () => { /* ... */ 
                setLoading(true); setError(''); setBehaviorResults([]); setCopiedSet(new Set());
                const allStudents = students.map(s => {
                    const traits = []; s.checks.forEach((status, name) => traits.push({ name, status: status === 1 ? 'ê¸ì •' : 'ì§€ë„í•„ìš”' }));
                    return { id: s.id, name: s.name || `í•™ìƒ${s.id}`, traits };
                });
                const minChars = Math.floor((targetBytes - 50) / 3); const maxChars = Math.floor((targetBytes + 100) / 3);
                const BATCH_SIZE = 5; const totalBatches = Math.ceil(allStudents.length / BATCH_SIZE);
                let accumulatedResults = []; const WAIT_TIME = getModelDelay(model);
                try {
                    for (let i = 0; i < totalBatches; i++) {
                        const start = i * BATCH_SIZE; const end = start + BATCH_SIZE; const batch = allStudents.slice(start, end);
                        setProgressMsg(`í–‰ë°œ ìƒì„± ì¤‘... (${i+1}/${totalBatches})`);
                        if (i > 0) await delay(WAIT_TIME);
                        const prompt = `ë‹¹ì‹ ì€ ë‹´ì„ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒ íŠ¹ì„±ì„ ë°”íƒ•ìœ¼ë¡œ í–‰ë°œì„ ì‘ì„±í•˜ì„¸ìš”.
                        [ë°ì´í„°]: ${JSON.stringify(batch)}
                        [ê·œì¹™]: 
                        1. ë¶„ëŸ‰: ê³µë°±í¬í•¨ ì•½ ${minChars}~${maxChars}ì (ì˜¤ì°¨ë²”ìœ„ ì¤€ìˆ˜).
                        2. ì–´ë¯¸: "-í•¨.", "-ì„." ëª…ì‚¬í˜•. ì£¼ì–´ ìƒëµ.
                        3. íŠ¹ìˆ˜ë¬¸ì(ì˜¨ì , ë°˜ì  ì œì™¸) ê¸ˆì§€.
                        [ì¶œë ¥(JSON)]: [{ "id": 1, "name": "...", "result": "..." }, ...]`;
                        const result = await callGemini(prompt);
                        if (Array.isArray(result)) { accumulatedResults = [...accumulatedResults, ...result]; setBehaviorResults([...accumulatedResults]); }
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); setProgressMsg(''); }
            };

            const generateCreative = async () => { 
                const validInputs = creativeInputs.filter(item => item.text.trim() !== '');
                if (validInputs.length === 0) { setError('ë¬¸ì¥ ì…ë ¥ í•„ìš”'); return; }
                setLoading(true); setProgressMsg('ì°½ì²´ ìƒì„± ì¤‘...'); setError(''); setCreativeResults(null); setCopiedSet(new Set());
                try {
                    const prompt = `ë‹¹ì‹ ì€ êµì‚¬ì…ë‹ˆë‹¤. ì…ë ¥ëœ ë¬¸ì¥ê³¼ ìœ ì‚¬í•œ ë¬¸ì¥ì„ ìƒì„±í•˜ì„¸ìš”.
                    
                    [ì…ë ¥ ë°ì´í„° (JSON)]
                    ${JSON.stringify(validInputs)}

                    [ì‘ì„± ê·œì¹™ - **ìˆ˜ëŸ‰ ì¤€ìˆ˜ í•„ìˆ˜**]
                    1. **ìˆ˜ëŸ‰**: ì…ë ¥ ë°ì´í„°ì˜ ê° í•­ëª©ì— ìˆëŠ” **"count" ìˆ«ìë§Œí¼ ì •í™•íˆ** ë³€í˜• ë¬¸ì¥ì„ ìƒì„±í•˜ì„¸ìš”. (ì˜ˆ: countê°€ 5ë©´ ë°˜ë“œì‹œ 5ê°œë¥¼ ìƒì„±, 10ì´ë©´ 10ê°œ)
                    2. **ì–´ë¯¸**: ë¬¸ì¥ì˜ ëì€ ë°˜ë“œì‹œ **"-í•¨."** ë˜ëŠ” **"-ì„."** ì´ ë‘ ê°€ì§€ ì¤‘ í•˜ë‚˜ë¡œë§Œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.
                    3. **ë‚´ìš©**: ì›ë¬¸ì˜ ê¸ì •ì  ë§¥ë½ ìœ ì§€í•˜ë˜ í‘œí˜„ ë‹¤ì–‘í™”. íŠ¹ìˆ˜ë¬¸ì ì œí•œ(ì˜¨ì , ë°˜ì ë§Œ í—ˆìš©).

                    [ì¶œë ¥(JSON)]: [{ "original": "...", "variations": ["...", ...] }, ...]`;
                    
                    const result = await callGemini(prompt);
                    setCreativeResults(result);
                } catch (err) { setError(err.message); } finally { setLoading(false); setProgressMsg(''); }
            };

            // 4. Excel Generator Function
            const generateExcelReport = async () => {
                if (!excelData || excelData.length === 0) {
                    setError("ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
                    return;
                }
                setLoading(true);
                setError('');
                setExcelResults([]);
                setCopiedSet(new Set());

                // í•™ìƒ 1ëª…ì”© ì²˜ë¦¬ (ë‚´ìš©ì´ ë§ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                let accumulatedResults = [];
                const WAIT_TIME = getModelDelay(model);

                try {
                    for (let i = 0; i < excelData.length; i++) {
                        const student = excelData[i];
                        setProgressMsg(`[${student.name}] í•™ìƒ í‰ì–´ ìƒì„± ì¤‘... (${i+1}/${excelData.length})`);

                        if (i > 0) await delay(WAIT_TIME);

                        const prompt = `
                            ë‹¹ì‹ ì€ êµì‚¬ì…ë‹ˆë‹¤. í•™ìƒì˜ ê³¼ëª©ë³„ ì„±ì·¨ ê¸°ì¤€ê³¼ ì„±ì ì„ ë°”íƒ•ìœ¼ë¡œ 'ê³¼ëª©ë³„ ì„¸ë¶€ëŠ¥ë ¥ ë° íŠ¹ê¸°ì‚¬í•­(í‰ì–´)'ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

                            [í•™ìƒ ì •ë³´]
                            ì´ë¦„: ${student.name}
                            ì„±ì  ë°ì´í„°: ${JSON.stringify(student.subjects)}

                            [ì‘ì„± ê·œì¹™ - **ì—„ê²© ì¤€ìˆ˜**]
                            1. **ì¶œë ¥ êµ¬ì¡°**: 
                               - ê° ê³¼ëª©ë³„ë¡œ í‰ì–´ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
                               - **ì¤‘ìš”**: í•´ë‹¹ ê³¼ëª©ì˜ **ê° ì„±ì·¨ ê¸°ì¤€(í‰ê°€ í•­ëª©)ë§ˆë‹¤ í•˜ë‚˜ì”© ë…ë¦½ëœ ë¬¸ì¥**ì„ ì‘ì„±í•˜ì„¸ìš”.
                               - **ì¤‘ìš”**: ì‘ì„±ëœ ê° ë¬¸ì¥ë“¤ì„ ì¤„ë°”ê¿ˆ ì—†ì´ **í•˜ë‚˜ì˜ ë¬¸ë‹¨(Paragraph)**ìœ¼ë¡œ ì´ì–´ ë¶™ì´ì„¸ìš”.
                               - (ì˜ëª»ëœ ì˜ˆ: ëª©ë¡í˜• ë‚˜ì—´)
                               - (ì˜¬ë°”ë¥¸ ì˜ˆ: "~~í•¨. ~~í•¨. ~~í•¨.")
                            2. **ì–´ë¯¸**: ë¬¸ì¥ì˜ ëì€ ë°˜ë“œì‹œ **"-í•¨."** ë˜ëŠ” **"-ì„."** ëª…ì‚¬í˜•ìœ¼ë¡œ ëë‚˜ì•¼ í•©ë‹ˆë‹¤.
                            3. **ë‚´ìš©**: 
                               - ì„±ì ì´ ìš°ìˆ˜í•œ í•­ëª©ì€ ê°•ì ì„ ì¹­ì°¬í•˜ê³ , ë¶€ì¡±í•œ í•­ëª©ì€ ë…¸ë ¥í•´ì•¼ í•  ì ì„ ê¸°ìˆ í•˜ì„¸ìš”.
                            4. **ê¸ˆì§€ ì‚¬í•­**: 
                               - íŠ¹ìˆ˜ë¬¸ì(ë”°ì˜´í‘œ, ê´„í˜¸ ë“±) ì‚¬ìš© ê¸ˆì§€. (ì˜¨ì , ë°˜ì ë§Œ í—ˆìš©)
                               - ì£¼ì–´(í•™ìƒ ì´ë¦„) ìƒëµ.
                            
                            [ì¶œë ¥ í˜•ì‹: JSON]
                            ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”.
                            {
                                "name": "${student.name}",
                                "results": {
                                    "êµ­ì–´": "êµ­ì–´ ì„±ì·¨ê¸°ì¤€1 í‰ê°€ ë¬¸ì¥. êµ­ì–´ ì„±ì·¨ê¸°ì¤€2 í‰ê°€ ë¬¸ì¥...",
                                    "ìˆ˜í•™": "ìˆ˜í•™ ì„±ì·¨ê¸°ì¤€1 í‰ê°€ ë¬¸ì¥. ìˆ˜í•™ ì„±ì·¨ê¸°ì¤€2 í‰ê°€ ë¬¸ì¥..."
                                }
                            }
                        `;

                        // 1ëª…ì”© ìš”ì²­í•˜ë¯€ë¡œ ë‹¨ì¼ ê°ì²´ ë°˜í™˜ ì˜ˆìƒ
                        const result = await callGemini(prompt);
                        if (result) {
                            accumulatedResults.push(result);
                            setExcelResults([...accumulatedResults]);
                        }
                    }
                } catch (err) {
                    setError(`ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`);
                } finally {
                    setLoading(false);
                    setProgressMsg('');
                }
            };

            return (
                <div className="min-h-screen py-8 px-4 sm:px-6 lg:px-8 max-w-6xl mx-auto">
                    {/* Header & API Key Section */}
                    <div className="text-center mb-8">
                        <h1 className="text-3xl font-extrabold text-gray-900">AI êµì‚¬ ë³´ì¡° ë„êµ¬</h1>
                        <p className="text-gray-500 text-sm mt-1">í‰ì–´, í–‰ë°œ, ì°½ì²´, ê³¼ëª©ë³„ í‰ê°€ ì‘ì„± ë„ìš°ë¯¸</p>
                    </div>
                    <div className="bg-white shadow-sm border border-gray-200 rounded-lg p-4 mb-6">
                        <div className="flex flex-col sm:flex-row items-end gap-4">
                            <div className="flex-1 w-full flex flex-col">
                                <label className="font-bold text-gray-700 text-sm mb-1">API Key ì…ë ¥</label>
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Google AI Studio API Key" className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" />
                            </div>
                            <button onClick={fetchAvailableModels} disabled={isFetchingModels || !apiKey} className="whitespace-nowrap px-4 py-2 rounded text-sm font-bold border border-blue-200 text-blue-700 hover:bg-blue-50 transition h-10 mb-[1px]">
                                {isFetchingModels ? 'ë¡œë”© ì¤‘...' : 'ğŸ” ëª¨ë¸ ì¡°íšŒ'}
                            </button>
                            <div className="w-full sm:w-64 flex flex-col">
                                <label className="font-bold text-gray-700 text-sm mb-1">AI ëª¨ë¸ ì„ íƒ</label>
                                <select value={model} onChange={(e) => setModel(e.target.value)} className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                    {modelList.map((m, idx) => <option key={idx} value={m.name.replace('models/', '')}>{m.displayName}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Navigation Tabs */}
                    <div className="flex flex-wrap gap-2 mb-6 justify-center">
                        {['comment', 'behavior', 'creative', 'excel'].map(m => (
                            <button key={m} onClick={() => { setMode(m); setError(''); }}
                                className={`px-4 py-2 rounded-md font-bold transition ${mode === m ? 'bg-blue-600 text-white shadow' : 'bg-white text-gray-500 hover:bg-gray-50 border border-gray-200'}`}>
                                {m === 'comment' && 'í‰ì–´ ìƒì„±ê¸°'}
                                {m === 'behavior' && 'í–‰ë°œ ìƒì„±ê¸°'}
                                {m === 'creative' && 'ì°½ì²´ ìƒì„±ê¸°'}
                                {m === 'excel' && 'ê³¼ëª©ë³„ í‰ì–´(Excel)'}
                            </button>
                        ))}
                    </div>

                    {/* Toast & Error */}
                    <div className={`toast-notification ${toast.show ? 'show' : 'hide'}`}><span>âœ…</span> {toast.msg}</div>
                    {error && <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow-sm whitespace-pre-line"><p className="font-bold">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</p><p>{error}</p></div>}

                    {/* ==== Modes ==== */}
                    {mode === 'comment' && (
                        /* ... ê¸°ì¡´ í‰ì–´ ìƒì„±ê¸° UI ... */
                        <div className="animate-fade-in">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                <div className="lg:col-span-2 bg-white shadow rounded-lg p-6 border border-gray-200">
                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-gray-800">ì„±ì·¨ ê¸°ì¤€ ì…ë ¥</h3><button onClick={addStandard} className="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 font-bold">+ ì¶”ê°€</button></div>
                                    <div className="space-y-3">{standards.map((std, i) => (<div key={i} className="flex gap-2"><input type="text" value={std} onChange={(e) => handleStandardChange(i, e.target.value)} placeholder="ì˜ˆ: ìì‹ ì˜ ê¿ˆì„ êµ¬ì²´ì ìœ¼ë¡œ í‘œí˜„í•œë‹¤." className="flex-1 p-2 border border-gray-300 rounded focus:border-blue-500 outline-none" />{standards.length > 1 && (<button onClick={() => removeStandard(i)} className="text-red-500 hover:text-red-700 px-2">âœ•</button>)}</div>))}</div>
                                </div>
                                <div className="bg-white shadow rounded-lg p-6 border border-gray-200 h-fit">
                                    <h3 className="font-bold text-lg text-gray-800 mb-4">ìƒì„± ì„¤ì •</h3>
                                    <div className="space-y-3">{[{k:'veryGood', l:'ë§¤ìš° ì˜í•¨', c:'text-blue-600'},{k:'good', l:'ì˜í•¨', c:'text-green-600'},{k:'average', l:'ë³´í†µ', c:'text-yellow-600'},{k:'needsEffort', l:'ë…¸ë ¥ìš”í•¨', c:'text-orange-600'}].map(lvl => (<div key={lvl.k} className="flex justify-between items-center"><span className={`font-medium ${lvl.c}`}>{lvl.l}</span><div className="flex items-center gap-1"><input type="number" value={counts[lvl.k]} onChange={(e)=>handleCountChange(lvl.k, e.target.value)} className="w-16 p-1 border rounded text-right" /><span className="text-sm text-gray-500">ê°œ</span></div></div>))}</div>
                                </div>
                            </div>
                            <button onClick={generateComments} disabled={loading} className={`w-full py-3 rounded-lg text-white font-bold text-lg shadow transition ${loading ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}`}>{loading ? <div className="flex justify-center items-center gap-2"><div className="loader"></div>{progressMsg || 'í‰ì–´ ìƒì„±í•˜ê¸°'}</div> : 'í‰ì–´ ìƒì„±í•˜ê¸°'}</button>
                            {commentResults && commentResults.length > 0 && (<div className="mt-8 bg-white shadow-lg rounded-lg overflow-hidden border border-gray-200"><div className="flex overflow-x-auto bg-gray-50 border-b">{commentResults.map((r, i) => (<button key={i} onClick={() => setActiveTab(i)} className={`px-5 py-3 text-sm font-bold whitespace-nowrap ${activeTab === i ? 'bg-white border-t-2 border-blue-600 text-blue-700' : 'text-gray-500 hover:bg-gray-100'}`}>ì„±ì·¨ê¸°ì¤€ {i+1}</button>))}</div><div className="p-6"><div className="bg-blue-50 p-3 rounded border border-blue-100 mb-6 text-sm text-blue-900 font-medium">{commentResults[activeTab]?.standard}</div><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{[{k:'veryGood', t:'ë§¤ìš° ì˜í•¨', bg:'bg-blue-50', b:'border-blue-200'},{k:'good', t:'ì˜í•¨', bg:'bg-green-50', b:'border-green-200'},{k:'average', t:'ë³´í†µ', bg:'bg-yellow-50', b:'border-yellow-200'},{k:'needsEffort', t:'ë…¸ë ¥ìš”í•¨', bg:'bg-orange-50', b:'border-orange-200'}].map(sec => (<div key={sec.k} className={`border ${sec.b} rounded-lg overflow-hidden`}><div className={`${sec.bg} px-3 py-2 font-bold text-gray-700 text-sm border-b ${sec.b} flex justify-between`}><span>{sec.t}</span><span className="bg-white px-2 rounded-full border text-xs flex items-center">{commentResults[activeTab]?.levels?.[sec.k]?.length || 0}</span></div><ul className="p-3 space-y-2 max-h-60 overflow-y-auto custom-scrollbar">{commentResults[activeTab]?.levels?.[sec.k]?.map((s, idx) => { const copyId = `c-${activeTab}-${sec.k}-${idx}`; const isCopied = copiedSet.has(copyId); return (<li key={idx} onClick={() => handleCopy(s, copyId)} className={`text-sm p-2 hover:bg-gray-50 rounded cursor-pointer group flex transition-colors duration-200 ${isCopied ? 'text-rose-600 font-semibold' : 'text-gray-700'}`}><span className="flex-1">{s}</span><span className="hidden group-hover:block text-xs text-gray-400 ml-1">{isCopied ? 'ë³µì‚¬ë¨' : 'ë³µì‚¬'}</span></li>); })}</ul></div>))}</div></div></div>)}
                        </div>
                    )}

                    {mode === 'behavior' && (
                        /* ... ê¸°ì¡´ í–‰ë°œ ìƒì„±ê¸° UI ... */
                        <div className="animate-fade-in">
                            <div className="bg-white shadow rounded-lg p-6 mb-6 border border-gray-200">
                                <div className="flex flex-col md:flex-row gap-6 justify-between items-end">
                                    <div className="flex gap-6 w-full md:w-auto">
                                        <div><label className="block font-bold text-gray-700 mb-1">í•™ìƒ ìˆ˜</label><input type="number" min="1" max="50" value={studentCount} onChange={handleStudentCountChange} className="w-24 p-2 border border-gray-300 rounded focus:border-green-500 outline-none" /></div>
                                        <div><label className="block font-bold text-gray-700 mb-1">ëª©í‘œ ë°”ì´íŠ¸</label><input type="number" step="100" value={targetBytes} onChange={(e) => setTargetBytes(parseInt(e.target.value) || 0)} className="w-32 p-2 border border-gray-300 rounded focus:border-green-500 outline-none" /></div>
                                    </div>
                                    <div className="text-right text-xs text-gray-500 w-full md:w-auto"><p>* <span className="text-blue-600 font-bold">1ë²ˆ(íŒŒë‘)</span>: ê¸ì •</p><p>* <span className="text-orange-600 font-bold">2ë²ˆ(ì£¼í™©)</span>: ì§€ë„í•„ìš”</p></div>
                                </div>
                            </div>
                            <div className="space-y-4 mb-8">{students.map((student, sIdx) => (<div key={student.id} className="bg-white shadow-sm border border-gray-200 rounded-lg overflow-hidden"><div className="bg-gray-50 px-4 py-3 border-b border-gray-200 flex flex-wrap items-center gap-3"><span className="font-bold text-green-900">No.{student.id}</span><input type="text" placeholder="í•™ìƒ ì´ë¦„" value={student.name} onChange={(e) => updateStudentName(sIdx, e.target.value)} className="p-1 px-2 border border-gray-300 rounded text-sm w-32 focus:border-green-500 outline-none" /><div className="flex-1 text-right text-xs text-blue-600 font-medium">ì„ íƒë¨: {student.checks.size}ê°œ</div></div><div className="p-4"><div className="grid grid-cols-1 md:grid-cols-12 gap-4"><div className="md:col-span-3 border-r md:border-r-0 lg:border-r border-gray-100 pr-2"><h4 className="font-bold text-sm text-gray-800 mb-2 border-b pb-1">ğŸ“š í•™ìŠµ</h4><div className="flex flex-col gap-2">{BEHAVIOR_CATEGORIES["í•™ìŠµ"].map(trait => { const checkState = student.checks.get(trait) || 0; return (<div key={trait} onClick={() => toggleCheck(sIdx, trait)} className={`trait-box cursor-pointer w-full text-sm px-3 py-2 rounded border border-gray-200 text-center select-none ${checkState === 1 ? 'state-1' : ''} ${checkState === 2 ? 'state-2' : ''} ${checkState === 0 ? 'text-gray-600 hover:bg-gray-50' : ''}`}>{trait.replace('í•™ìŠµ(', '').replace(')', '')}</div>); })}</div></div><div className="md:col-span-7 border-r md:border-r-0 lg:border-r border-gray-100 pr-2 px-2"><h4 className="font-bold text-sm text-gray-800 mb-2 border-b pb-1">ğŸ˜Š ì„±ê²©/ì¸ì„±</h4><div className="grid grid-cols-3 sm:grid-cols-4 gap-2">{BEHAVIOR_CATEGORIES["ì„±ê²©"].map(trait => { const checkState = student.checks.get(trait) || 0; return (<div key={trait} onClick={() => toggleCheck(sIdx, trait)} className={`trait-box cursor-pointer w-full text-sm px-2 py-2 rounded border border-gray-200 text-center truncate select-none ${checkState === 1 ? 'state-1' : ''} ${checkState === 2 ? 'state-2' : ''} ${checkState === 0 ? 'text-gray-600 hover:bg-gray-50' : ''}`}>{trait}</div>); })}</div></div><div className="md:col-span-2 pl-2"><h4 className="font-bold text-sm text-gray-800 mb-2 border-b pb-1">ğŸ¨ ì˜ˆì²´ëŠ¥</h4><div className="flex flex-col gap-2">{BEHAVIOR_CATEGORIES["ì˜ˆì²´ëŠ¥"].map(trait => { const checkState = student.checks.get(trait) || 0; return (<div key={trait} onClick={() => toggleCheck(sIdx, trait)} className={`trait-box cursor-pointer w-full text-sm px-3 py-2 rounded border border-gray-200 text-center select-none ${checkState === 1 ? 'state-1' : ''} ${checkState === 2 ? 'state-2' : ''} ${checkState === 0 ? 'text-gray-600 hover:bg-gray-50' : ''}`}>{trait}</div>); })}</div></div></div></div></div>))}</div>
                            <button onClick={generateBehavior} disabled={loading} className={`w-full py-3 rounded-lg text-white font-bold text-lg shadow transition ${loading ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'}`}>{loading ? <div className="flex justify-center items-center gap-2"><div className="loader"></div>{progressMsg || 'í–‰ë°œ ìƒì„±í•˜ê¸°'}</div> : 'í–‰ë°œ ìƒì„±í•˜ê¸°'}</button>
                            {behaviorResults && (<div className="mt-8 grid gap-6">{behaviorResults.map((res, i) => { const copyId = `b-${i}`; const isCopied = copiedSet.has(copyId); return (<div key={i} className="bg-white shadow rounded-lg border border-gray-200 overflow-hidden"><div className="bg-green-50 px-4 py-3 border-b border-green-100 flex justify-between items-center"><span className="font-bold text-green-900">{res.name || `í•™ìƒ ${res.id}`} <span className="text-xs font-normal text-green-700 ml-2">(ì•½ {calculateBytes(res.result)} Bytes)</span></span><button onClick={() => handleCopy(res.result, copyId)} className={`text-xs border px-2 py-1 rounded transition-colors duration-200 ${isCopied ? 'bg-rose-100 text-rose-600 border-rose-200 font-bold' : 'bg-white text-green-700 border-green-200 hover:bg-green-100'}`}>{isCopied ? 'ë³µì‚¬ë¨' : 'ë³µì‚¬'}</button></div><div className={`p-4 text-sm leading-relaxed whitespace-pre-wrap ${isCopied ? 'text-rose-600 font-medium' : 'text-gray-700'}`}>{res.result}</div></div>); })}</div>)}
                        </div>
                    )}

                    {mode === 'creative' && (
                        /* ... ê¸°ì¡´ ì°½ì²´ ìƒì„±ê¸° UI ... */
                        <div className="animate-fade-in">
                            <div className="bg-white shadow rounded-lg p-6 mb-6 border border-gray-200">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-gray-800">ì°½ì²´ íŠ¹ê¸°ì‚¬í•­ ì…ë ¥</h3><button onClick={addCreativeInput} className="text-sm bg-purple-100 text-purple-700 px-3 py-1 rounded hover:bg-purple-200 font-bold">+ ë¬¸ì¥ ì¶”ê°€</button></div>
                                <div className="space-y-4">{creativeInputs.map((input, idx) => (<div key={idx} className="flex flex-col sm:flex-row gap-3 items-start sm:items-center bg-gray-50 p-3 rounded border border-gray-200"><div className="flex-1 w-full"><input type="text" value={input.text} onChange={(e) => handleCreativeChange(idx, 'text', e.target.value)} placeholder="ì˜ˆ: ì¶•ì œ ë¶€ìŠ¤ ìš´ì˜ì„ ì£¼ë„í•¨." className="w-full p-2 border border-gray-300 rounded focus:border-purple-500 outline-none" /></div><div className="flex items-center gap-2"><span className="text-sm font-medium text-gray-600 whitespace-nowrap">ìƒì„± ê°œìˆ˜:</span><input type="number" value={input.count} onChange={(e) => handleCreativeChange(idx, 'count', e.target.value)} className="w-16 p-2 border border-gray-300 rounded focus:border-purple-500 outline-none text-right" min="1" max="20" /><span className="text-sm text-gray-500">ê°œ</span></div>{creativeInputs.length > 1 && (<button onClick={() => removeCreativeInput(idx)} className="text-red-500 hover:text-red-700 p-2">âœ•</button>)}</div>))}</div>
                            </div>
                            <button onClick={generateCreative} disabled={loading} className={`w-full py-3 rounded-lg text-white font-bold text-lg shadow transition ${loading ? 'bg-gray-400' : 'bg-purple-600 hover:bg-purple-700'}`}>{loading ? <div className="flex justify-center items-center gap-2"><div className="loader"></div>{progressMsg || 'ìœ ì‚¬ ë¬¸ì¥ ìƒì„±í•˜ê¸°'}</div> : 'ìœ ì‚¬ ë¬¸ì¥ ìƒì„±í•˜ê¸°'}</button>
                            {creativeResults && (<div className="mt-8 space-y-6">{creativeResults.map((item, idx) => (<div key={idx} className="bg-white shadow rounded-lg border border-gray-200 overflow-hidden"><div className="bg-purple-50 px-4 py-3 border-b border-purple-100"><h4 className="font-bold text-purple-900 text-sm mb-1">[ì›ë¬¸]</h4><p className="text-gray-700 text-sm">{item.original}</p></div><div className="p-4"><h4 className="font-bold text-gray-800 text-sm mb-3">âœ¨ ìƒì„±ëœ ë³€í˜• ë¬¸ì¥ ({item.variations.length}ê°œ)</h4><ul className="space-y-2">{item.variations.map((sent, sIdx) => { const copyId = `cr-${idx}-${sIdx}`; const isCopied = copiedSet.has(copyId); return (<li key={sIdx} onClick={() => handleCopy(sent, copyId)} className={`text-sm p-3 bg-gray-50 hover:bg-purple-50 rounded border border-gray-100 cursor-pointer group flex transition-colors duration-200 ${isCopied ? 'text-rose-600 font-semibold' : 'text-gray-700'}`}><span className="flex-1">{sent}</span><span className="hidden group-hover:block text-xs text-purple-400 ml-2 font-medium">{isCopied ? 'ë³µì‚¬ë¨' : 'ë³µì‚¬'}</span></li>); })}</ul></div></div>))}</div>)}
                        </div>
                    )}

                    {/* ================= MODE 4: ê³¼ëª©ë³„ í‰ì–´ (Excel) ================= */}
                    {mode === 'excel' && (
                        <div className="animate-fade-in">
                            {/* File Upload Section */}
                            <div className="bg-white shadow rounded-lg p-6 mb-6 border border-gray-200">
                                <h3 className="font-bold text-lg text-gray-800 mb-4">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
                                <div className="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:bg-gray-50 transition cursor-pointer relative">
                                    <input type="file" accept=".xlsx, .xls" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    <div className="py-6">
                                        <p className="text-gray-500 mb-1">ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                                        <p className="text-xs text-gray-400">í˜•ì‹: 1ì—´(ì´ë¦„), ì´í›„ ì—´ í—¤ë”(ê³¼ëª©-ì„±ì·¨ê¸°ì¤€)</p>
                                    </div>
                                </div>
                                {excelData && (<div className="mt-4 p-3 bg-green-50 rounded border border-green-200 text-sm text-green-800">ğŸ“‹ í™•ì¸ëœ ë°ì´í„°: <strong>{excelData.length}ëª…</strong>ì˜ í•™ìƒ</div>)}
                            </div>

                            <button onClick={generateExcelReport} disabled={loading || !excelData} className={`w-full py-3 rounded-lg text-white font-bold text-lg shadow transition ${loading || !excelData ? 'bg-gray-400' : 'bg-teal-600 hover:bg-teal-700'}`}>{loading ? <div className="flex justify-center items-center gap-2"><div className="loader"></div>{progressMsg || 'ë¶„ì„ ë° ìƒì„± ì¤‘...'}</div> : 'ê³¼ëª©ë³„ í‰ì–´ ìƒì„±í•˜ê¸°'}</button>

                            {/* Excel Results Display */}
                            {pivotedExcelData && (
                                <div className="mt-8 bg-white shadow-lg rounded-lg overflow-hidden border border-gray-200">
                                    <div className="flex justify-between items-center p-4 border-b bg-gray-50">
                                        <div className="flex overflow-x-auto gap-2">
                                            {Object.keys(pivotedExcelData).map(subject => (
                                                <button key={subject} onClick={() => setExcelSubjectTab(subject)} className={`px-4 py-2 rounded-md text-sm font-bold whitespace-nowrap transition ${excelSubjectTab === subject ? 'bg-teal-600 text-white shadow' : 'bg-white text-gray-600 border hover:bg-gray-100'}`}>
                                                    {subject}
                                                </button>
                                            ))}
                                        </div>
                                        <button onClick={downloadHwp} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-bold shadow transition flex items-center gap-1 whitespace-nowrap ml-4">
                                            ğŸ’¾ HWP ë‹¤ìš´ë¡œë“œ
                                        </button>
                                    </div>

                                    <div className="p-6">
                                        {excelSubjectTab && pivotedExcelData[excelSubjectTab] ? (
                                            <div className="overflow-x-auto">
                                                <h3 className="font-bold text-lg text-teal-800 mb-3 border-b pb-2">{excelSubjectTab} ê³¼ëª© í‰ì–´</h3>
                                                <table className="min-w-full divide-y divide-gray-200">
                                                    <thead className="bg-gray-50">
                                                        <tr>
                                                            <th scope="col" className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-24">ì´ë¦„</th>
                                                            <th scope="col" className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">í‰ê°€ ë‚´ìš© (í•œ ë¬¸ë‹¨)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white divide-y divide-gray-200">
                                                        {pivotedExcelData[excelSubjectTab].map((student, idx) => {
                                                            const copyId = `ex-${excelSubjectTab}-${idx}`;
                                                            const isCopied = copiedSet.has(copyId);
                                                            return (
                                                                <tr key={idx} onClick={() => handleCopy(student.comment, copyId)} className={`hover:bg-gray-50 cursor-pointer group transition-colors ${isCopied ? 'bg-teal-50' : ''}`}>
                                                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-center">{student.name}</td>
                                                                    <td className={`px-6 py-4 text-sm ${isCopied ? 'text-teal-700 font-medium' : 'text-gray-700'}`}>
                                                                        {student.comment}
                                                                        <span className="hidden group-hover:inline-block ml-2 text-xs text-gray-400 font-normal float-right">ë³µì‚¬í•˜ê¸°</span>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ) : (
                                            <div className="text-center py-10 text-gray-500">ìƒì„±ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
